{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "primaryName": {
            "type": "string",
            "allowedValues": [
                "Blue",
                "Green"
            ]
        }
    },
    "variables": {
        "trafficManagerName": "ServicesMarstonMe",
        "dnsZoneName": "services.marston.me",
        "trafficManagerRelativeName": "[replace(variables('dnsZoneName'), '.', '')]",
        "BlueSecondaryName": "Green",
        "GreenSecondaryName": "Blue",
        "secondaryName": "[variables(concat(parameters('primaryName'), 'SecondaryName'))]",
        "primaryPublicIpName": "[concat('ServicesPIP', parameters('primaryName'))]",
        "primaryPublicIpFqdn": "[concat(toLower(parameters('primaryName')), '.', variables('dnsZoneName'))]",
        "secondaryPublicIpFqdn": "[concat(toLower(variables('secondaryName')), '.', variables('dnsZoneName'))]",
        "secondaryPublicIpName": "[concat('ServicesPIP', variables('secondaryName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/dnszones/CNAME",
            "name": "[concat(variables('dnsZoneName'), '/teamcity')]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "CNAMERecord": {
                    "cname": "[reference(resourceId('Microsoft.Network/trafficManagerProfiles', variables('trafficManagerName'))).dnsConfig.fqdn]"
                }
            }
        },
        {
            "type": "Microsoft.Network/dnszones/CNAME",
            "name": "[concat(variables('dnsZoneName'), '/proget')]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "CNAMERecord": {
                    "cname": "[reference(resourceId('Microsoft.Network/trafficManagerProfiles', variables('trafficManagerName'))).dnsConfig.fqdn]"
                }
            }
        },
        {
            "type": "Microsoft.Network/dnszones/CNAME",
            "name": "[concat(variables('dnsZoneName'), '/octopus')]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "CNAMERecord": {
                    "cname": "[reference(resourceId('Microsoft.Network/trafficManagerProfiles', variables('trafficManagerName'))).dnsConfig.fqdn]"
                }
            }
        },{
            "type": "Microsoft.Network/trafficManagerProfiles",
            "name": "[variables('trafficManagerName')]",
            "apiVersion": "2015-11-01",
            "location": "global",
            "properties": {
                "profileStatus": "Enabled",
                "trafficRoutingMethod": "Priority",
                "dnsConfig": {
                    "relativeName": "[variables('trafficManagerRelativeName')]",
                    "ttl": 30
                },
                "monitorConfig": {
                    "protocol": "HTTP",
                    "port": 80,
                    "path": "/healthcheck.txt"
                },
                "endpoints": [{
                    "name": "[parameters('primaryName')]",
                    "type": "Microsoft.Network/trafficManagerProfiles/externalEndpoints",
                    "properties": {
                        "target": "[variables('primaryPublicIpFqdn')]",
                        "endpointLocation": "[resourceGroup().location]",
                        "endpointStatus": "Enabled",
                        "priority": "10"
                    }
                }, {
                    "name": "[variables('secondaryName')]",
                    "type": "Microsoft.Network/trafficManagerProfiles/externalEndpoints",
                    "properties": {
                        "target": "[variables('secondaryPublicIpFqdn')]",
                        "endpointLocation": "[resourceGroup().location]",
                        "endpointStatus": "Disabled",
                        "priority": "20"
                    }
                }]
            }
        },
        {
            "type": "Microsoft.Network/dnszones/A",
            "name": "[concat(variables('dnsZoneName'), '/@')]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "ARecords": [{
                    "ipv4Address": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('primaryPublicIpName'))).IpAddress]"
                }]
            }
        },
        {
            "type": "Microsoft.Network/dnszones/A",
            "name": "[concat(variables('dnsZoneName'), '/', toLower(parameters('primaryName')))]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "ARecords": [{
                    "ipv4Address": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('primaryPublicIpName'))).IpAddress]"
                }]
            }
        },
        {
            "type": "Microsoft.Network/dnszones/A",
            "name": "[concat(variables('dnsZoneName'), '/', toLower(variables('secondaryName')))]",
            "apiVersion": "2016-04-01",
            "properties": {
                "TTL": 3600,
                "ARecords": [{
                    "ipv4Address": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('secondaryPublicIpName'))).IpAddress]"
                }]
            }
        },
        {
            "apiVersion": "2016-12-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('primaryPublicIpName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 30,
                "dnsSettings": {
                    "domainNameLabel": "[replace(variables('primaryPublicIpFqdn'), '.', '')]",
                    "reverseFqdn": "[concat(variables('primaryPublicIpFqdn'), '.')]"
                }
            }
        },
        {
            "apiVersion": "2016-12-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('secondaryPublicIpName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 30,
                "dnsSettings": {
                    "domainNameLabel": "[replace(variables('secondaryPublicIpFqdn'), '.', '')]",
                    "reverseFqdn": "[concat(variables('secondaryPublicIpFqdn'), '.')]"
                }
            }
        }
    ]
}